## II. 검색

### 1. 쿼리 컨텍스트와 필터 컨텍스트

- **쿼리 컨텍스트**: 질의에 대한 유사도를 계산하여 더 정확한 결과를 먼저 보여준다.
  - 유사도 점수(relevance score)를 기반으로 검색 결과를 정렬한다.
  - 예: 문서에 "엘라스틱"이 포함되어 있는지 검색하고, 연관성이 높은 결과를 우선적으로 반환.

- **필터 컨텍스트**: 유사도를 계산하지 않고 일치 여부에 따른 결과만을 반환한다.
  - 캐시를 활용하여 성능을 최적화한다. (엘라스틱서치는 기본적으로 힙 메모리의 10%를 캐시에 사용).
  - 예: 문서 제목이 "엘라스틱"인 문서를 찾는 경우.

| 특징              | 쿼리 컨텍스트                                    | 필터 컨텍스트                              |
|-------------------|------------------------------------------------|------------------------------------------|
| **유사도 점수**   | 계산함                                         | 계산하지 않음                             |
| **결과 반환 형태** | 연관성 점수를 포함한 정렬된 결과               | 일치 여부만 판단하여 반환                 |
| **성능 최적화**   | 없음                                           | 캐시 사용 가능                            |

- 쿼리 컨텍스트는 **BM25 알고리즘**을 사용하여 유사도를 계산한다.

### 2. BM25 알고리즘

BM25는 검색 및 추천 시스템에 널리 사용되는 알고리즘으로, 다음 개념에 기반한다:

- **TF (Term Frequency)**: 특정 용어가 문서에서 얼마나 자주 등장했는지를 나타내는 지표.
  - 특정 단어가 많이 등장할수록 문서의 주제와 관련 있을 확률이 높다.

  \[ \text{TF Formula} = \frac{\text{FREQ}}{\text{FREQ} + k_1 \cdot (1 - b + b \cdot \frac{\text{dl}}{\text{avgdl}})} \]

- **IDF (Inverse Document Frequency)**: 특정 용어가 다른 문서에 얼마나 드물게 나타나는지를 나타내는 지표.
  - 드물게 등장하는 단어일수록 가중치가 높다.

  \[ \text{IDF Formula} = \log\left(1 + \frac{N - n + 0.5}{n + 0.5}\right) \]
  - \(N\): 전체 문서 수
  - \(n\): 특정 단어가 등장한 문서 수

### 3. 쿼리 방식

엘라스틱서치에서 검색을 위해 제공하는 주요 방식은 다음과 같다:

1. **쿼리 스트링**: 간단한 검색어를 위한 한 줄짜리 쿼리.
2. **쿼리 DSL (Domain-Specific Language)**: 복잡한 검색 조건을 정의할 때 사용.

#### 예제

```json
GET kibana_sample_data_ecommerce/_search
{
  "query": {
    "match": {
      "customer_full_name": "Mary"
    }
  }
}
```

### 4. 쿼리 유형

엘라스틱서치 쿼리는 크게 **리프 쿼리**와 **복합 쿼리**로 나뉜다.

#### 4.1 리프 쿼리 (Leaf Query)

- 특정 필드에서 용어를 찾는 쿼리.
- 주요 유형:
  - **전문 쿼리**: 텍스트 타입으로 매핑된 필드에 적합. (예: 블로그 글 검색)
    - **매치 쿼리**, **매치 프레이즈 쿼리**, **멀티 매치 쿼리** 등.
  - **용어 수준 쿼리**: 키워드 타입으로 매핑된 필드에 적합. (예: 정확히 일치하는 값 검색)
    - **용어 쿼리**, **용어들 쿼리**.

#### 4.2 복합 쿼리 (Compound Query)

- 리프 쿼리를 조합하여 복잡한 논리 구조를 표현.
- 주요 유형:
  - **bool 쿼리**: `must`, `should`, `must_not` 조건을 조합.
  - **boosting 쿼리**: 특정 쿼리의 점수를 높이거나 낮춤.
  - **constant_score 쿼리**: 유사도 점수 대신 고정된 점수를 반환.

---

### 추가한 내용

1. **쿼리 유형**: 복합 쿼리에 대한 설명을 추가하여 검색 기능의 다양성을 보강.
2. **BM25 공식**: TF 및 IDF 계산 공식을 수식으로 명확히 표현.
3. **리프 쿼리와 복합 쿼리**: 차이를 명확히 설명하고 예제를 구체화.

